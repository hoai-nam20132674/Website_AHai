app.service('order',function($uibModal){this.cartModal=function(data,buyer,step,buy){if(!buy){return;}
$uibModal.open({animation:true,templateUrl:'cartModal',controller:'cartModal',backdrop:'static',size:'lg',resolve:{params:function(){return{items:data.items,packages:data.packages,buyer:buyer,step:step}}}});};this.total=function(items){var total=0;for(var i=0;i<items.length;i++){if(items[i].available==1){total+=items[i].price*items[i].quantity;}}
return total;}
this.weight=function(items){var total=0;for(var i=0;i<items.length;i++){if(items[i].available==1){if(items[i].shippingWeightMultiple>0)
total+=items[i].weight*items[i].quantity*items[i].shippingWeightMultiple;else
total+=items[i].weight*items[i].quantity;}}
return total;}
this.deliveryLimitation=function(packages){var deliveryLimitation=0;angular.forEach(packages,function(v,k){angular.forEach(packages[k].items,function(v1,k1){if(packages[k].items[k1].deliveryLimitation==1){deliveryLimitation=1;}});});return deliveryLimitation;};this.final=function(packages){var final=0;angular.forEach(packages,function(v,k){angular.forEach(packages[k].items,function(v1,k1){final+=packages[k].items[k1].price*packages[k].items[k1].quantity;});});return final;}});app.controller('otp',function($scope,modal){$scope.oid='';$scope.otp='';$scope.message='';$scope.checkOtp=false;$scope.success=false;$scope.loading=false;$scope.checkSend=false;$scope.loadingResendOtp=false;$scope.init=function(){$scope.oid=oid;}
$scope.resendOtp=function(){$scope.loadingResendOtp=true;$.ajax({url:baseUrl+'/order/resendotp',data:{oid:$scope.oid},method:'GET',success:function(resp){$scope.$apply(function(){$scope.loadingResendOtp=false;$scope.checkSend=true;});}});};$scope.change=function(){if($scope.otp.replace("_","").length>5){$('.g-recaptcha').show();}}
$scope.ok=function(){$scope.message='OTP không đúng';$scope.checkOtp=false;if($scope.otp.replace("_","").length>5){$scope.loading=true;$.ajax({url:baseUrl+'/order/confirmotp',data:{oid:$scope.oid,otp:$scope.otp,token:$('#g-recaptcha-response').val()},method:'GET',success:function(resp){$scope.loading=false;if(resp.success){location.href=baseUrl+'/hoa-don/'+$scope.oid;}else{$scope.$apply(function(){$scope.message=resp.message;$scope.checkOtp=true;});}}});}else{if($scope.otp.replace("_","").length==0){$scope.message='OTP chưa nhập';}
$scope.checkOtp=true;}}});app.controller('cart_page',function($scope,$uibModal,$rootScope,$rootScope,order,modal,localStorageService,auth){$scope.changed=false;$scope.promotionValue=0;$scope.showMessagePromotion=0;$scope.buyer={paymentMethod:'cod',buyerProvinceId:0,buyerDistrictId:0,buyerWardId:0,shipmentMethod:2,o2opostman:1,promotionCode:''};$scope.init=function(){loading.show();$.ajax({url:baseUrl+'/order/getpackage',method:'GET',success:function(resp){loading.hide();$scope.$apply(function(){$scope.packages=resp.data.packages;$scope.isSteelPortfolio=resp.data.isSteelPortfolio;$scope.isAvaiableBuyOrder=resp.data.isAvaiableBuyOrder;$scope.isNotSteelPortfolio=resp.data.isNotSteelPortfolio;$scope.isAllSteelPortfolio=resp.data.isAllSteelPortfolio;$scope.totalShipping=0.0;if(resp.data.packages[0]){if(resp.data.packages[0].coupon){$scope.buyer.promotionCode=resp.data.packages[0].coupon;}
$scope.buyer.promotionId=resp.data.packages[0].promotionId;}
if(resp.data.user){$scope.buyer.buyerName=resp.data.user.name;$scope.buyer.buyerPhone=resp.data.user.phone;$scope.buyer.buyerEmail=resp.data.user.email;$scope.buyer.buyerProvinceId=resp.data.user.provinceId;$scope.buyer.buyerDistrictId=resp.data.user.districtId;$scope.buyer.buyerWardId=resp.data.user.wardId;$scope.buyer.buyerAddress=resp.data.user.address;$scope.calculateOrderAmount();$scope.caculateTotalShippingPackages();}
console.log($scope.buyer.promotionCode);});}});$.ajax({url:baseUrl+'/order/get-promotion',method:'GET',success:function(resp){loading.hide();$scope.$apply(function(){$scope.promotions=resp.data;if(!$scope.buyer.promotionId&&$scope.promotions.length>0)
$scope.buyer.promotionId=12;});}});$scope.provinces=JSON.parse(localStorage.getItem('provinces'));$scope.districts=JSON.parse(localStorage.getItem('districts'));$scope.wards=JSON.parse(localStorage.getItem('wards'));}
$scope.init();$scope.updateBuyer=function(){}
$scope.nomessage=true;$scope.applyPromotion=function(){if($scope.calculated){loading.show();$.ajax({url:baseUrl+'/order/apply-promotion',data:{promotionId:$scope.buyer.promotionId,promotionCode:$scope.buyer.promotionCode,provinceId:$scope.buyer.buyerProvinceId,districtId:$scope.buyer.buyerDistrictId,wardId:$scope.buyer.buyerWardId,address:$scope.buyer.buyerAddress,paymentMethod:$scope.buyer.paymentMethod,shipmentMethod:$scope.buyer.shipmentMethod,},method:'GET',success:function(resp){loading.hide();if(resp.success){$scope.$apply(function(){$scope.packages=resp.data;$scope.calculateOrderAmount();});}
if(resp.message&&$scope.nomessage){modal.alert(resp.message);}
$scope.nomessage=true;}});}
else{modal.alert('Vui lòng nhập đủ thông tin đơn hàng');}};$scope.caculateTotalShippingPackages=function(){if($scope.packages.length>0&&$scope.buyer.buyerDistrictId&&$scope.buyer.buyerProvinceId&&$scope.buyer.buyerWardId&&$scope.wards&&$scope.districts&&$scope.provinces){loading.show();$.ajax({url:baseUrl+'/order/caculatetotalshippingpackages',data:{packages:$scope.packages,toProvinceId:$scope.buyer.buyerProvinceId,toDistrictId:$scope.buyer.buyerDistrictId,paymentMethod:$scope.buyer.paymentMethod,shipmentMethod:$scope.buyer.shipmentMethod,},method:'POST',success:function(resp){loading.hide();if(resp.success){$scope.$apply(function(){$scope.packages=resp.data.packages;$scope.totalShipping=0.0;angular.forEach($scope.packages,function(value,key){$scope.totalShipping+=(parseInt(value.totalShippingFee));$scope.packages[key].promotionAmount=0;if(value.isFreeShip*1==1){$scope.packages[key].promotionAmount+=value.totalShippingFee;}});$scope.calculated=true;$scope.calculateOrderAmount();if($scope.buyer.promotionCode||$scope.buyer.promotionId){$scope.nomessage=false;$scope.applyPromotion();}});}else{if(resp.message){modal.alert(resp.message);}}}});}}
$scope.update=function(item,q,rm){item.quantity=parseInt(item.quantity)+q;if(item.quantity<1||!item.quantity){item.quantity=1;}
loading.show();$.ajax({url:baseUrl+'/order/update',data:{id:item.id,quantity:rm?0:item.quantity},method:'GET',success:function(resp){loading.hide();if(!resp.success){item.quantity=parseInt(item.quantity)-q;modal.alert(resp.message);return;}
$scope.$apply(function(){$scope.items=resp.data.items;$scope.packages=resp.data.packages;$scope.total=order.total($scope.items);$scope.final=order.final($scope.packages);$scope.caculateTotalShippingPackages();$scope.calculateOrderAmount();});}});$.ajax({url:baseUrl+'/auth/get-package',method:'GET',success:function(resp){if(resp.success){$('span.total_items').text(resp.data.total_items);}else{$('span.total_items').text(0);}}});};$scope.ok=function(isAvaiableBuyOrder){if(!isAvaiableBuyOrder)return;loading.show();$.ajax({url:baseUrl+'/order/buy',data:utils.buildFormData('OrderForm',$scope.buyer),method:'POST',success:function(resp){if(resp.success){$scope.$apply(function(){$scope.items=resp.data.cart;$scope.buyer=resp.data.order;localStorageService.set('userInfo',resp.data.order);$scope.step=2;ga('ecommerce:addTransaction',{'id':resp.data.order.id,'affiliation':'voso.vn','revenue':order.total(resp.data.cart),'shipping':'0','tax':'0'});for(var i=0;i<resp.data.cart;i++){var item=resp.data.cart[i];if(item.available==1){ga('ecommerce:addItem',{'id':resp.data.order.id,'name':item.name,'sku':item.url,'category':'Tất cả','price':item.price,'quantity':item.quantity});}}
ga('ecommerce:send');});location.href=baseUrl+'/hoa-don/'+resp.data.order.code;}else{$scope.$apply(function(){$scope.errors=resp.data;});if(resp.message){modal.alert(resp.message);}}
loading.hide();}});};$scope.checkemail=function(email){$.ajax({url:baseUrl+'/auth/checkemail',method:'GET',success:function(resp){if(resp.success){auth.signin();}else{auth.signup();}}});}
$scope.thumb=function(image){var imageUrl=imboClient.getImageUrl(image);return imageUrl.maxSize({width:80,height:50}).compress({level:100}).toString();};$scope.calculateOrderAmount=function(){$scope.promotionValue=0;$scope.final=0;var totalShippingFee=0;$.each($scope.packages,function(k,v){if(v.promotionAmount)
$scope.promotionValue+=parseInt(v.promotionAmount);$.each(v.items,function(k1,v1){$scope.final+=parseInt(v1.price)*parseInt(v1.quantity);});totalShippingFee+=parseInt(v.totalShippingFee);});$scope.orderAmount=parseInt($scope.final)+parseInt(totalShippingFee)-$scope.promotionValue;if($scope.orderAmount<0)$scope.orderAmount=0;}
$scope.subtotal=function(package){return order.total(package.items);};$scope.subweight=function(package){return order.weight(package.items);};$scope.kpiht=function(a){return Math.ceil((parseInt(a)+24)/24)+' ngày';};$scope.pakageValue=function(a,p){var total=0;if(a)total+=parseInt(a);if(p.totalShippingFee*1>0)total+=parseInt(p.totalShippingFee*1);if(p.promotionAmount*1>0)total-=parseInt(p.promotionAmount*1);if(total<0)return 0;return total;};$scope.deliveryLimitation=order.deliveryLimitation($scope.packages);});