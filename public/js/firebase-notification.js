app.service('firebaseNotification',function($uibModal,$rootScope){var _self=this;_self.token='';_self.messaging=null;_self.onTokenRefresh=function(){_self.messaging.getToken().then((refreshedToken)=>{_self.setTokenSentToServer(false);_self.sendTokenToServer(refreshedToken);_self.resetUI();}).catch((err)=>{});};_self.onMessage=function(payload){$rootScope.$emit("Authcontroller_ReloadNotifications");};_self.resetUI=function(forceSendToServer){if(!_self.messaging){_self.messaging=firebase.messaging();_self.messaging.usePublicVapidKey('BLLwHHS2tAwVNYBKgjuMKcGBy1-LzEK3jM-u7FQHHBwvv9k1dx5YorEIunmnJCatnq8P8HvQhI8Ck3bKvJRlQzo');_self.messaging.onTokenRefresh(()=>_self.onTokenRefresh());_self.messaging.onMessage(payload=>_self.onMessage(payload));navigator.serviceWorker.addEventListener('message',event=>{const eventData=event.data;if(eventData&&eventData.type==='firebase-messaging-push-notification'){$rootScope.$emit("Authcontroller_ReloadNotifications");}else if(eventData&&eventData.type==='firebase-messaging-push-notification-click'){$rootScope.$emit("Authcontroller_NotificationClick",eventData);}});}
_self.messaging.getToken().then((currentToken)=>{if(currentToken){_self.sendTokenToServer(currentToken,forceSendToServer);}else{_self.setTokenSentToServer(false);_self.requestPermission();}}).catch((err)=>{_self.setTokenSentToServer(false);});};_self.sendTokenToServer=function(currentToken,forceSendToServer){_self.token=currentToken;$rootScope.$emit("Authcontroller_UpdateFirebasePushToken",{token:currentToken});if(!_self.isTokenSentToServer()||forceSendToServer){_self.setTokenSentToServer(true);$.ajax({url:baseUrl+'/notification/update-web-token',method:'POST',data:{token:currentToken},success:function(resp){}});}else{}};_self.isTokenSentToServer=function(){return window.localStorage.getItem('sentToServer')==='1';};_self.setTokenSentToServer=function(sent){window.localStorage.setItem('sentToServer',sent?'1':'0');};_self.requestPermission=function(){Notification.requestPermission().then((permission)=>{if(permission==='granted'){_self.resetUI();}else{}});};_self.deleteToken=function(){_self.messaging.getToken().then((currentToken)=>{_self.messaging.deleteToken(currentToken).then(()=>{_self.setTokenSentToServer(false);}).catch((err)=>{});}).catch((err)=>{});};_self.appendMessage=function(payload){};});