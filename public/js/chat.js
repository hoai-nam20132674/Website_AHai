var activeUserChat=0;var activeUserChatUUID='';app.controller('chatCtrl',function($scope,$rootScope,$firebaseArray,$firebaseObject,$firebaseAuth,modal,fileDialog,$timeout,$q){$scope.$watch(function(){return $rootScope.user;},function(){if(typeof $scope.sender==='undefined'&&$rootScope.user){init();}},true);function init(){$scope.totalUnseen=0;$scope.sender={name:$rootScope.user.name,avatar:'48dc2432ba339b3176cd2c90ad06b785',firebaseUUID:$rootScope.user.firebaseUUID}
$scope.chatMessages=$firebaseArray(firebase.database().ref().child($scope.sender.firebaseUUID).orderByChild('lastUpdateReverse').limitToLast(100));$scope.chatMessages.$loaded().then(function(data){loadMessage();});$scope.chatMessages.$watch(function(event){loadMessage();});if(window.localStorage.getItem('showChatBox')===null){$scope.display=false;window.localStorage.setItem('showChatBox',$scope.display);}
else{if(window.localStorage.getItem('showChatBox')=='false')
$scope.display=false;else
$scope.display=true;}
$("#conversation").animate({scrollTop:$(document).height()},100);}
$scope.toggleChat=function(forceOpen){if(!$rootScope.user){modal.alert('Vui lòng đăng nhập để chat');}
else{window.localStorage.setItem('showChatBox',$scope.display);if(forceOpen){$('#v__chat').show();}else{$('#v__chat').toggle();}}}
$scope.toggleChatShow=function(forceOpen){if(!$rootScope.user){modal.alert('Vui lòng đăng nhập để chat');}
else{$('#v__chat').show();}}
$scope.toggleChatHide=function(forceOpen){$('#v__chat').hide();}
$scope.seen=function(uuid=null){if(uuid){seen(uuid);}else{if(typeof($scope.receiver.firebaseUUID)!='undefined'){seen($scope.receiver.firebaseUUID);}}}
function loadMessage(){$scope.totalUnseen=0;if($scope.chatMessages[0]&&!$scope.receiver&&$scope.chatMessages[0].topic){$scope.msgs=$scope.chatMessages[0];$scope.receiver=$scope.chatMessages[0].topic.receiver;$scope.chatMessages[0].$active=true;}
angular.forEach($scope.chatMessages,function(v,k){$scope.chatMessages[k].$unseen=0;$scope.chatMessages[k].$active=false;if(activeUserChat>0){if(activeUserChatUUID==$scope.chatMessages[k].$id){$scope.chatMessages[k].$active=true;$scope.msgs=$scope.chatMessages[k];$scope.receiver=$scope.chatMessages[k].topic.receiver;}}
angular.forEach(v.messages,function(v1,k1){if(!v1.me&&!v1.seen){$scope.chatMessages[k].$unseen+=1;}});$scope.totalUnseen+=parseInt($scope.chatMessages[k].$unseen);});$("#conversation").animate({scrollTop:$('#full-message').prop("scrollHeight")},100);}
function seen(uuid){$scope.chatMessages.map(x=>{if(x.topic.receiver.firebaseUUID==uuid){msg=$firebaseArray(firebase.database().ref().child($scope.sender.firebaseUUID).child(uuid).child("messages"));msg.$loaded().then(function(data){angular.forEach(data,function(v,k){msg[k].seen=true;msg.$save(k);});});msgs=$firebaseArray(firebase.database().ref().child(uuid).child($scope.sender.firebaseUUID).child("messages"));msgs.$loaded().then(function(data){angular.forEach(data,function(v,k){msgs[k].seen=true;msgs.$save(k);});});}});}
$scope.chat=function(merchantId,forceOpen){activeUserChat=merchantId;if(!$rootScope.user){modal.alert('Vui lòng đăng nhập để chat');}
else{if(!$scope.sender){init();}
if(typeof(receiver)==='undefined'||!receiver.firebaseUUID){$.ajax({url:baseUrl+'/site/create-topic?merchantId='+merchantId,method:'GET',success:function(resp){loading.hide();if(resp.success){$scope.$apply(function(){$scope.receiver=resp.data;$scope.send(true);$scope.toggleChat(forceOpen);if(merchantId>0){activeUserChatUUID=resp.data.firebaseUUID;}});}}});}else{$scope.receiver=receiver;if(merchantId>0){activeUserChatUUID=receiver.firebaseUUID;}
$scope.display=true;$scope.send();$scope.toggleChat(forceOpen);}}};$scope.showChat=function(merchantId,forceOpen){activeUserChat=merchantId;if(!$rootScope.user){modal.alert('Vui lòng đăng nhập để chat');}
else{if(!$scope.sender){init();}
if(typeof(receiver)==='undefined'||!receiver.firebaseUUID){$.ajax({url:baseUrl+'/site/create-topic?merchantId='+merchantId,method:'GET',success:function(resp){loading.hide();if(resp.success){$scope.$apply(function(){$scope.receiver=resp.data;$scope.send(true);$scope.toggleChatShow(forceOpen);if(merchantId>0){activeUserChatUUID=resp.data.firebaseUUID;}});}}});}else{$scope.receiver=receiver;if(merchantId>0){activeUserChatUUID=receiver.firebaseUUID;}
$scope.display=true;$scope.send();$scope.toggleChatShow(forceOpen);}}};$scope.send=function(cb=false){$('#chatfield').focus();$("#conversation").animate({scrollTop:$(document).height()},100);message=angular.copy($scope.chatMes);$scope.chatMes="";sendMSG(firebase.database().ref().child($scope.sender.firebaseUUID).child($scope.receiver.firebaseUUID),message,true,'message','');sendMSG(firebase.database().ref().child($scope.receiver.firebaseUUID).child($scope.sender.firebaseUUID),message,false,'message','');if(cb){$scope.showMessagess(0);}}
function sendMSG(thread,message,isSender,typeAttach,attach){thread.child('topic').update({sender:isSender?$scope.sender:$scope.receiver,receiver:isSender?$scope.receiver:$scope.sender});if(message){msg=$firebaseArray(thread.child("messages"));msg.$add({message:message,datetime:Date.now(),seen:false,typeAttach:typeAttach,attach:attach,me:isSender});if(isSender){var receiverId=isSender?$scope.receiver.firebaseUUID:$scope.sender.firebaseUUID;$scope.pushNotificationToReceiverApp(receiverId,message);}}
thread.update({lastUpdate:Date.now(),lastUpdateReverse:0-Date.now()})}
$scope.pushNotificationToReceiverApp=function(receiverId,message){$.ajax({url:baseUrl+'/notification/push-chat',method:'POST',data:{receiverId,message},success:function(resp){}});}
$scope.showMessagess=function(index){$scope.receiver=$scope.chatMessages[index].topic.receiver;$scope.chatMessages.map((e)=>e.$active=false);$scope.chatMessages[index].$active=true;$scope.msgs=$scope.chatMessages[index];$scope.seen($scope.receiver.firebaseUUID);$('.v__chat-body-mobile .v__chat-left').animate({left:'-'+toggleWidth+'px'});$('.v__chat-body-mobile .v__chat-right').animate({left:'0px'});$("#conversation").animate({scrollTop:$('#full-message').prop("scrollHeight")},100);};var toggleWidth=$("#v__chat-body").width();$('.v__chat-body-mobile .v__chat-right').css('left',toggleWidth);$scope.showMessages=function(index){$scope.receiver=$scope.chatMessages[index].topic.receiver;$scope.chatMessages.map((e)=>e.$active=false);$scope.chatMessages[index].$active=true;$scope.msgs=$scope.chatMessages[index];$scope.seen($scope.receiver.firebaseUUID);$('.v__chat-body-mobile .v__chat-left').animate({left:'-'+toggleWidth+'px'});$('.v__chat-body-mobile .v__chat-right').animate({left:'0px'});$("#conversation").animate({scrollTop:$('#full-message').prop("scrollHeight")},100);};$scope.returnListUser=function(index){var toggleWidth=$("#v__chat-body").width();$('.v__chat-body-mobile .v__chat-left').animate({left:'0px'});$('.v__chat-body-mobile .v__chat-right').css('left',toggleWidth);};$scope.thumb=function(image){if(image==null||image==''){image='48dc2432ba339b3176cd2c90ad06b785';}
if(image){var imageUrl=imboClient.getImageUrl(image);if(imageUrl){return imageUrl.maxSize({width:80,height:50}).compress({level:100}).toString();}}
return '';};$scope.getImage=function(image){if(image==null||image==''){return '';}
if(image){var imageUrl=imboClient.getImageUrl(image);if(imageUrl){return imageUrl.maxSize({width:320}).compress({level:100}).toString();}}
return '';};$scope.inputImage=function(){fileDialog.openFile(function(files){imboClient.addImage(files[0],{onComplete:function(err,imageIdentifier,res){if(err){return bootbox.alert("Xin lỗi, upload ảnh không thành công, file upload phải là ảnh có kích thước không quá 16MB, vui lòng kiểm tra và thử lại!");}
$scope.$apply(function(){sendMSG(firebase.database().ref().child($scope.sender.firebaseUUID).child($scope.receiver.firebaseUUID),'1',true,'image',imageIdentifier);sendMSG(firebase.database().ref().child($scope.receiver.firebaseUUID).child($scope.sender.firebaseUUID),'1',false,'image',imageIdentifier);var imageUrl=imboClient.getImageUrl(imageIdentifier);imageUrl=imageUrl.maxSize({width:320}).compress({level:100}).toString();});},onProgress:function(e){if(!e.lengthComputable){return;}
$scope.$apply(function(){});}});},false);};$scope.search=function(){angular.forEach($scope.chatMessages,function(v,k){if(!v.topic.receiver.name.toLowerCase().includes($scope.personName.toLowerCase())){$scope.chatMessages[k].topic.$hide=true;}
else{$scope.chatMessages[k].topic.$hide=false;}});}
$rootScope.$on("ChatController_OpenChat",function(event,params){if(params&&params.sender){receiver={firebaseUUID:params.sender.senderId,name:params.sender.senderName,avatar:params.sender.senderAvatar};$scope.receiver=receiver;$scope.chat(params.sender.senderId,true);}});});