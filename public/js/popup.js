app.controller('popup',function($scope,$timeout){$scope.data=null;$scope.canDisplay=false;$scope.isFull=true;$scope.isMobile=/iPhone|iPod|Android/i.test(navigator.userAgent);$scope.localData={};$scope.run=function(){$.ajax({url:baseUrl+"/site/get-popup",method:"GET",success:function(res){if(res.success){$scope.$apply(function(){$scope.data=res.data;var imageUrl=imboClient.getImageUrl($scope.data.image);if($scope.isMobile){$scope.data.image=imageUrl.maxSize({width:$(window).width()*2/3,height:$(window).height()/2}).compress({level:100}).toString();}else{$scope.data.image=imageUrl.compress({level:100}).toString();}
$scope.data.image_thumb=imageUrl.maxSize({width:$(window).width()/4,height:$(window).height()/4}).compress({level:100}).toString();$scope.checkDisplayCondition();});}}});};$scope.checkDisplayCondition=function(){var key='popup_history_'+$scope.data.id;var history=localStorage.getItem(key);if(history){history=JSON.parse(history);$scope.localData=history;if(history.display<$scope.data.max_display_count){$scope.canDisplay=true;}}else{$scope.canDisplay=true;}
if($scope.canDisplay){$scope.timer=$timeout(function(){if($scope.timer){$scope.logDisplay();$scope.isFull=false;$scope.isFull=false;if($scope.isMobile){$scope.canDisplay=false;}}},5000);}};$scope.logDisplay=function(){var key='popup_history_'+$scope.data.id;if($scope.localData.display){$scope.localData.display++;}else{$scope.localData.display=1;}
$scope.localData.time=new Date();localStorage.setItem(key,JSON.stringify($scope.localData));};$scope.clickPopup=function(){$scope.logDisplay();if(utils.getHostName($scope.data.url)===window.location.hostname){window.location.href=$scope.data.url;}else{window.open($scope.data.url,'_blank');}};$scope.thumb=function(){$scope.logDisplay();$scope.isFull=false;if($scope.isMobile){$scope.canDisplay=false;}
if($scope.timer){$timeout.cancel($scope.timer);$scope.timer=null;}};$scope.close=function(){$scope.canDisplay=false;};$scope.run();});